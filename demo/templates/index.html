<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GPT 聊天</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh; 
            margin: 0; 
            font-family: Arial, sans-serif;
            background-color: #f9f9f9; 
        }

        .container {
            width: 70%;
            margin: 0 auto;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .chat-box {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            position: relative; /* 设置父容器为相对定位 */
        }

        textarea {
            width: calc(100% - 100px); /* 减去按钮的宽度及间距 */
            resize: none;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* 确保宽度计算正确 */
        }

        .send-button {
            position: absolute; /* 绝对定位按钮 */
            bottom: 25px; /* 距离父容器底部 10px */
            right: 10px; /* 距离父容器右侧 10px */
            padding: 10px 20px;
            font-size: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007BFF;
            color: white;
        }

        .send-button:hover {
            background-color: #0056b3;
        }

        .response-box, .history-box {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .response-container {
            min-height: 50px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f5f5f5;
        }

        .history-content {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }

        .logout-link {
            display: block;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            color: #007BFF;
        }

        .logout-link:hover {
            text-decoration: underline;
        }

        .pagination-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    {% if logged_in %}
      <div class="container">
          <p>用户{{ username }}已登录</p>
          <div class="chat-box">
              <h2>GPT 聊天</h2>
              <p style="font-weight: bold;">输入您的问题：</p>
              <textarea id="userInput" rows="4" placeholder="请输入您的问题..."></textarea>
              <button onclick="sendMessage()" class="send-button">发送给 GPT</button>
          </div>

          <div class="response-box">
              <h2>GPT 回复：</h2>
              <div id="responseBox" class="response-container"></div>
          </div>

          <div class="history-box">
              <h2>聊天历史记录</h2>
              <button onclick="loadHistory()">查看历史记录</button>
              <div id="historyContent" class="history-content"></div>
          </div>
      </div>

        <a href="/logout" class="logout-link">退出登录</a>

        <script>
          // 发送消息给GPT
          async function sendMessage() {
            const userInput = document.getElementById("userInput").value.trim();
            if (!userInput) {
              alert("输入不能为空!");
              return;
            }
            try {
              const res = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: userInput })
              });
              const data = await res.json();
              document.getElementById("responseBox").innerText = data.reply || data.error || "未知错误";
            } catch (error) {
              console.error(error);
              alert("请求出错了!");
            }
          }

          // 加载历史记录
          async function loadHistory(page=1, size=10) {
            try {
              const res = await fetch(`/history?page=${page}&size=${size}`);
              const data = await res.json();

              if (data.error) {
                document.getElementById("historyContent").innerText = data.error;
                return;
              }
              
              // 显示分页信息
              let historyHtml = `<p>第 ${data.current_page} 页 / 共 ${data.total_pages} 页 (共 ${data.total} 条记录)</p>`;

              // 遍历记录，生成HTML
              data.records.forEach(rec => {
                historyHtml += `
                  <div style="margin-bottom: 10px;">
                    <strong>时间:</strong> ${rec.created_at}<br>
                    <strong>问题:</strong> ${rec.question}<br>
                    <strong>回答:</strong> ${rec.answer}
                  </div>
                  <hr>
                `;
              });

              // 如果有多页，可以加“上一页/下一页”按钮
              historyHtml += '<div class="pagination-buttons">';
              if (data.current_page > 1) {
                historyHtml += `<button onclick="loadHistory(${data.current_page - 1}, ${data.page_size})">上一页</button>`;
              }
              if (data.current_page < data.total_pages) {
                historyHtml += `<button onclick="loadHistory(${data.current_page + 1}, ${data.page_size})">下一页</button>`;
              }
              historyHtml += '</div>';

              document.getElementById("historyContent").innerHTML = historyHtml;
            } catch (error) {
              console.error(error);
              alert("加载历史记录出错!");
            }
          }
        </script>

    {% else %}
        <p>您尚未登录，请先 <a href="/login">登录</a> 或 <a href="/register">注册</a>.</p>
    {% endif %}
</body>
</html>
